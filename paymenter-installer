#!/bin/bash
set -euo pipefail

# Kleuren
GREEN="\e[32m"
RED="\e[31m"
YELLOW="\e[33m"
BLUE="\e[34m"
RESET="\e[0m"

log() { echo -e "${BLUE}[INFO]${RESET} $1"; }
success() { echo -e "${GREEN}[OK]${RESET} $1"; }
warn() { echo -e "${YELLOW}[WARN]${RESET} $1"; }

# ================= INPUT =================
echo "Welkom bij de Paymenter installer!"
echo "-----------------------------------"

read -p "Voer database wachtwoord in voor Paymenter DB: " DB_PASSWORD
read -p "Voer je domeinnaam in (bijv. paymenter.example.com): " DOMAIN
read -p "Voer admin voornaam in: " ADMIN_FIRST
read -p "Voer admin achternaam in: " ADMIN_LAST
read -p "Voer admin e-mail in: " ADMIN_EMAIL
read -sp "Voer admin wachtwoord in: " ADMIN_PASS
echo ""

# ================= DEPENDENCIES =================
install_dependencies() {
    log "Dependencies installeren..."
    apt -y install software-properties-common curl apt-transport-https ca-certificates gnupg lsb-release
    LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php
    curl -sSL https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | \
        sudo bash -s -- --mariadb-server-version="mariadb-10.11"
    apt update
    apt -y install php8.3 php8.3-{common,cli,gd,mysql,mbstring,bcmath,xml,fpm,curl,zip,intl,redis} \
                   mariadb-server nginx tar unzip git redis-server
    curl -sS https://getcomposer.org/installer | \
        sudo php -- --install-dir=/usr/local/bin --filename=composer
    success "Alle dependencies zijn geïnstalleerd."
}

# ================= DATABASE =================
setup_database() {
    log "Database configureren..."
    mysql -uroot -e "DROP DATABASE IF EXISTS paymenter;"
    mysql -uroot -e "CREATE DATABASE paymenter;"
    mysql -uroot -e "DROP USER IF EXISTS 'paymenter'@'127.0.0.1';"
    mysql -uroot -e "CREATE USER 'paymenter'@'127.0.0.1' IDENTIFIED BY '${DB_PASSWORD}';"
    mysql -uroot -e "GRANT ALL PRIVILEGES ON paymenter.* TO 'paymenter'@'127.0.0.1' WITH GRANT OPTION;"
    success "Database en gebruiker 'paymenter' aangemaakt."
}

# ================= PAYMENTER INSTALLER =================
install_paymenter() {
    log "Paymenter downloaden..."
    rm -rf /var/www/paymenter
    mkdir -p /var/www/paymenter
    cd /var/www/paymenter
    curl -Lo paymenter.tar.gz https://github.com/paymenter/paymenter/releases/latest/download/paymenter.tar.gz
    tar -xzvf paymenter.tar.gz
    chmod -R 755 storage/* bootstrap/cache/
    success "Paymenter is gedownload."
}

# ================= NGINX CONFIG =================
configure_nginx() {
    log "Nginx configureren..."
    cat <<EOF > /etc/nginx/sites-available/paymenter.conf
server {
    listen 80;
    listen [::]:80;
    server_name $DOMAIN;
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name $DOMAIN;
    root /var/www/paymenter/public;
    
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;
    charset utf-8;

    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ ^/index\.php(/|$) {
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }
}
EOF
    ln -sf /etc/nginx/sites-available/paymenter.conf /etc/nginx/sites-enabled/
    systemctl restart nginx
    success "Nginx geconfigureerd."

    log "SSL installeren met Certbot..."
    apt -y install certbot python3-certbot-nginx
    certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos -m "$ADMIN_EMAIL"
    success "SSL certificaat geïnstalleerd."
}

# ================= CONFIG PAYMENTER =================
configure_paymenter() {
    log "Paymenter configureren..."
    cd /var/www/paymenter
    cp .env.example .env
    composer install --no-dev --optimize-autoloader
    php artisan key:generate --force
    php artisan storage:link

    sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${DB_PASSWORD}/" .env

    php artisan migrate --force --seed
    php artisan db:seed --class=CustomPropertySeeder
    php artisan app:init
    chown -R www-data:www-data /var/www/paymenter/*
    success "Paymenter configuratie afgerond."
}

# ================= CRONJOB + QUEUE =================
setup_cron_and_queue() {
    log "Cronjob toevoegen..."
    (crontab -l 2>/dev/null; echo "* * * * * php /var/www/paymenter/artisan schedule:run >> /dev/null 2>&1") | crontab -
    success "Cronjob ingesteld."

    log "Queue service maken..."
    cat <<EOF > /etc/systemd/system/paymenter.service
[Unit]
Description=Paymenter Queue Worker

[Service]
User=www-data
Group=www-data
Restart=always
ExecStart=/usr/bin/php /var/www/paymenter/artisan queue:work
StartLimitInterval=180
StartLimitBurst=30
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

    systemctl enable --now paymenter.service
    systemctl enable --now redis-server
    success "Queue worker & Redis actief."
}

# ================= CREATE ADMIN =================
create_first_user() {
    log "Admin gebruiker aanmaken..."
    cd /var/www/paymenter
    php artisan app:user:create \
      --first-name="$ADMIN_FIRST" \
      --last-name="$ADMIN_LAST" \
      --email="$ADMIN_EMAIL" \
      --password="$ADMIN_PASS" \
      --admin=1
    success "Admin gebruiker aangemaakt: $ADMIN_FIRST $ADMIN_LAST ($ADMIN_EMAIL)"
}

# ================= SCRIPT FLOW =================
install_dependencies
setup_database
install_paymenter
configure_nginx
configure_paymenter
setup_cron_and_queue
create_first_user
success "Paymenter installatie compleet!"
echo "Bezoek: https://$DOMAIN"
